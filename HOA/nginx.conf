# ============================================================
# ÇORLU LİHKAB - Nginx Configuration
# ============================================================
#
# Nerede kullanılır:
# ✓ Custom VPS (Nginx + Gunicorn)
# ✓ AWS, DigitalOcean
# ✗ Render.com / Heroku (kendi nginx'leri var)
#
# Yedekleme: /etc/nginx/sites-available/corlulihkab
# Aktif etme: ln -s /etc/nginx/sites-available/corlulihkab /etc/nginx/sites-enabled/
# Test: nginx -t
# Restart: systemctl restart nginx
#
# ============================================================

upstream gunicorn_app {
    # Gunicorn worker'ları (0.0.0.0:8000'da çalışıyor)
    server 127.0.0.1:8000;
}

server {
    # ============================================================
    # HTTPS SETUP (Let's Encrypt + Certbot)
    # ============================================================
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    
    server_name www.corlulihkab.com corlulihkab.com;
    
    # SSL Sertifikat (Certbot'tan)
    ssl_certificate /etc/letsencrypt/live/corlulihkab.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/corlulihkab.com/privkey.pem;
    
    # SSL Optimize
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_prefer_server_ciphers on;
    
    # ============================================================
    # LOGGING
    # ============================================================
    access_log /var/log/nginx/corlulihkab_access.log;
    error_log /var/log/nginx/corlulihkab_error.log;
    
    # ============================================================
    # CLIENT LIMITS
    # ============================================================
    # Upload limit (formlar için)
    client_max_body_size 10M;
    
    # Connection timeout
    keepalive_timeout 65;
    
    # ============================================================
    # GZIP COMPRESSION
    # ============================================================
    gzip on;
    gzip_vary on;
    gzip_min_length 1000;
    gzip_types text/plain text/css text/xml text/javascript 
               application/x-javascript application/xml+rss 
               application/javascript application/json;
    gzip_disable "msie6";
    
    # ============================================================
    # CACHE HEADERS
    # ============================================================
    
    # Static files - 1 yıl cache
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|webp|woff|woff2|ttf|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Vary Accept-Encoding;
    }
    
    # HTML - 1 saat cache
    location ~* \.html?$ {
        expires 1h;
        add_header Cache-Control "public, must-revalidate";
    }
    
    # JSON - 1 saat cache
    location ~* \.json$ {
        expires 1h;
        add_header Cache-Control "public, must-revalidate";
    }
    
    # ============================================================
    # SECURITY HEADERS
    # ============================================================
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    
    # HSTS (HTTPS sıkı enforcing)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    
    # ============================================================
    # STATIC FILES (direct serve - Gunicorn'a gitme)
    # ============================================================
    location /static/ {
        alias /var/www/corlulihkab/static/;
        access_log off;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # ============================================================
    # PYTHON APPLICATION (Gunicorn'a proxy)
    # ============================================================
    location / {
        proxy_pass http://gunicorn_app;
        
        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Buffering
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }
    
    # ============================================================
    # ERROR PAGES
    # ============================================================
    error_page 404 /404.html;
    error_page 500 502 503 504 /500.html;
    
    # ============================================================
    # DENY ACCESS (güvenlik)
    # ============================================================
    # Hidden files (.git, .env vb)
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# ============================================================
# HTTP → HTTPS REDIRECT
# ============================================================
server {
    listen 80;
    listen [::]:80;
    server_name www.corlulihkab.com corlulihkab.com;
    
    # Let's Encrypt verification
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
    
    # Tüm diğer traffic'i HTTPS'e yönlendir
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# ============================================================
# GUNICORN SETUP (Systemd Service)
# ============================================================
#
# /etc/systemd/system/gunicorn.service:
#
# [Unit]
# Description=Gunicorn service for ÇORLU LİHKAB
# After=network.target
#
# [Service]
# Type=notify
# User=www-data
# WorkingDirectory=/var/www/corlulihkab
# ExecStart=/var/www/corlulihkab/venv/bin/gunicorn \
#     --workers 4 \
#     --worker-class sync \
#     --bind 0.0.0.0:8000 \
#     app:app
# Restart=always
#
# [Install]
# WantedBy=multi-user.target
#
# ============================================================
# DEPLOYMENT CHECKLIST
# ============================================================
#
# 1. Python Virtual Environment:
#    cd /var/www/corlulihkab
#    python3 -m venv venv
#    source venv/bin/activate
#    pip install -r requirements.txt
#
# 2. Gunicorn Service:
#    systemctl enable gunicorn
#    systemctl start gunicorn
#    systemctl status gunicorn
#
# 3. Nginx:
#    cp nginx.conf /etc/nginx/sites-available/corlulihkab
#    nginx -t
#    systemctl enable nginx
#    systemctl restart nginx
#
# 4. SSL Certificate:
#    sudo certbot certonly --webroot -w /var/www/certbot \
#        -d www.corlulihkab.com -d corlulihkab.com
#    certbot renew --dry-run  # Test
#
# 5. Firewall:
#    ufw allow 22/tcp    # SSH
#    ufw allow 80/tcp    # HTTP
#    ufw allow 443/tcp   # HTTPS
#    ufw enable
#
# ============================================================
